<!doctype html>
<html ng-app>
<head>
  <title></title>
<style>
body {
  background-color: #fff;
  font-family: Helvetica, sans-serif;
  font-size: 48px;
}

.main {
-webkit-perspective: 550px;
margin-left: 200px;
margin-top: 50px;
  padding: 0;
}

.albumDiv {
  -webkit-transform: rotateY(35deg) scale(1);
  float: left;
}

.albumImg {
  background-color: #eee;
-webkit-box-reflect: below 0px -webkit-gradient(linear, left top, left bottom, from(transparent), color-stop(0.5, transparent), to(rgba(50,50,50,0.7)));
}

.textInfo {
  margin-left: 75px;
  float: left;
}
</style>
</head>
<body>
  <div ng-controller="NowPlayingCtrl">
    <div class="main">
      <div class="albumDiv">
        <img ng-src="{{currentTrack.albumArt}}" class="albumImg" id="albumImgId">
      </div>
      <div class="textInfo">
        <p>
          {{currentTrack.title}}<br>
          {{currentTrack.album}}<br>
          {{currentTrack.artist}}<br>
        </p>
      </div>
    </div>
  </div>

  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.0.4/angular.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
  var HISTORY_SIZE = 5;

  var createCORSRequest = function(method, url) {
    var xhr = new XMLHttpRequest();
    if ("withCredentials" in xhr) {

      // Check if the XMLHttpRequest object has a "withCredentials" property.
      // "withCredentials" only exists on XMLHTTPRequest2 objects.
      xhr.open(method, url, true);

    } else if (typeof XDomainRequest != "undefined") {

      // Otherwise, check if XDomainRequest.
      // XDomainRequest only exists in IE, and is IE's way of making CORS requests.
      xhr = new XDomainRequest();
      xhr.open(method, url);

    } else {

      // Otherwise, CORS is not supported by the browser.
      xhr = null;

    }
    return xhr;
  }

    var AlbumArt = function() {
      this.cache = {};
    };

    AlbumArt.prototype.add = function(artist, album, data) {
      if (!(artist in this.cache)) {
        this.cache[artist] = {}
      }
      this.cache[artist][album] = data;
    };

    AlbumArt.prototype.lookup = function(artist, album) {
      if (artist in this.cache) {
        var cache = this.cache[artist];
        if (album in cache) {
          return cache[album];
        }
      }
      return null;
    };

    AlbumArt.prototype.createUrl = function(artist, album) {
      var url = 'http://ws.audioscrobbler.com/2.0/?method=album.getinfo&api_key=e83f749f1a6d33bd385c86914d012c67&format=json';
      url += '&artist=' + encodeURIComponent(artist);
      url += '&album=' + encodeURIComponent(album);
      return url;
    };

    AlbumArt.prototype.get = function(artist, album, callback) {
      var that = this;
      var data = this.lookup(artist, album);
      if (data) {
        callback(data);
        return;
      }

      var url = this.createUrl(artist, album);
      var xhr = createCORSRequest('GET', url);

      xhr.onerror = function() {
        console.log('There was an error!');
      };

      xhr.onload = function() {
        var data = null;
        try {
          data = JSON.parse(xhr.responseText);
        } catch(e) {
          console.log(e);
          return callback();
        }
        if ('error' in data) {
          console.log(data);
          return callback();
        }

        that.add(artist, album, data);
        return callback(data);
      };

      xhr.send();
    };

    var albumArtCache = new AlbumArt();


    function NowPlayingCtrl($scope) {
      $scope.currentTrack = null;
      $scope.history = [];

      var setSizes = function() {
        var multiplier = .6;
        var dh = document.height;
        var dw = document.width;
        var size = Math.min(dh, dw)*multiplier;
        var album = document.getElementById('albumImgId');
        album.height = size;
        album.width = size;
      };
      setSizes();

      var socket = io.connect();

      socket.on('newTrack', function(data) {
        if (trackEquals($scope.currentTrack, data)) {
          return;
        }

        if (('artist' in data) && ('album' in data)) {
          albumArtCache.get(data['artist'], data['album'], function(resp) {
            var images = resp['album']['image'];
            updateData(data, images[images.length-1]['#text']);
          })
        } else {
          updateData(data);
        }
      });

      var updateData = function(data, albumArt) {
        $scope.history.unshift($scope.currentTrack);
        while ($scope.history.length > HISTORY_SIZE) {
          $scope.history.pop();
        }

        data['albumArt'] = albumArt;
        $scope.currentTrack = data;

        $scope.$apply();
      }
    }

    // Compares two track objects.
    var trackEquals = function(track1, track2) {
      if (!track1 || !track2) {
        return false;
      }
      return track1.title === track2.title &&
          track1.artist === track2.artist &&
          track1.album === track2.album;
    };

  </script>
</body>
</html>